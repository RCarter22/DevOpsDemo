<!DOCTYPE html>
<html ng-app="map" ng-controller="SidebarController" ng-cloak emm-nonavigation>
<head>
	<title>EZMaxMobile</title>
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="pragma" content="no-cache" />
	<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
	<meta name="format-detection" content="telephone=no">
	<meta content="minimum-scale=1.0, width=device-width, maximum-scale=0.6667, user-scalable=no" name="viewport" />
	<link href="../../images/ezmaxmobile.ico" rel="shortcut icon" />
	<link href="../../css/ezmaxmobile.ui-full.min.css" rel="stylesheet" type="text/css" />
	<script src="../../javascript/jquery.js" type="text/javascript"></script>
	<script src="../../javascript/ezmaxmobile.core-full.min.js" type="text/javascript"></script>
	<script src="../../javascript/angular.min.js" type="text/javascript"></script>
	<script src="../../javascript/angular-translate.min.js" type="text/javascript"></script>
	<script src="../../javascript/angular/emm-pagination.js" type="text/javascript"></script>
	<!-- Localization Files -->
	<script src="../../javascript/localization/en_US.js" type="text/javascript"></script>
	<script src="../../javascript/localization/zh_TW.js" type="text/javascript"></script>
</head>
<body>
	<div class="ui-page">
		<div class="ui-searchbar">
			<form ng-submit="quicksearch()" novalidate>
				<input type="search" placeholder="Search Work Orders" ng-model="search"/>
			</form>
		</div>		
		<div class="ui-content">
			<ul class="ui-listview">
				<li class="ui-divider">Work Order List</li>
			</ul>	
			<ul pagination class="ui-listview"></ul>			
			<ul class="ui-listview">							
				<li ng-repeat="d in data | startFrom:pageService.startFrom() | limitTo:pageService.getPageSize()">
					<a ng-click="map(d)">					
						<p><strong>{{d.WONUM}}</strong></p>
						<h3>{{d.DESCRIPTION}}</h3>
						<p>Long: {{d.X}}</p>
						<p>Lat: {{d.Y}}</p>
						<span class="ui-arrow"></span>
					</a>
				</li>
			</ul>
			<ul pagination class="ui-listview"></ul>
		</div>
	</div>
	<script type="text/javascript">
		var map = angular.module('map', ['emm.pagination']);	
		
		map.controller('SidebarController', function ($scope, $document, $http, pageService){		
			$scope.pageService = pageService;				
			
			$scope.search = null;		
			
			$scope.quicksearch = function(){
				var filter = {};
				if ($scope.search){
					filter["search"] = $scope.search;			
				}
				emm.maps.filter('WORKORDERS', filter);
				$(document.activeElement).blur(); // Hides keyboard
			}			
			
			$scope.zoomTo = function(lat, lng, zoom){
				emm.maps.zoomToPoint(new emm.maps.LatLng(lat, lng), zoom);
			}			
			
			$document.bind('dataSourceLoaded', function(event, data){
				$(document).scrollTop();
				$scope.$apply(function(){
					$scope.data = data.dataSources['WORKORDERS'];
					// Update pagination
					$scope.pageService.setNumberOfRecords($scope.data.length);					
				});
			});
			
			$scope.map = function(d){
				emm.maps.zoomTo('WORKORDERS', 'WORKORDERID', d.WORKORDERID)
			}
			
		});
	</script>
</body>
</html>
